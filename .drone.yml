kind: pipeline
type: kubernetes
name: default

clone:
  depth: 1
  skip_verify: true

steps:
  - name: php-cli
    image: plugins/docker
    volumes:
      - name: dockersock
        path: /var/run
    settings:
      # mirror: https://mirror.ccs.tencentyun.com
      # mirror: https://nex18i4o.mirror.aliyuncs.com
      # mtu: 1450
      daemon_off: "true"
      # dry_run: "true"
      context: php-cli
      dockerfile: php-cli/Dockerfile
      build_args:
        - PHP_TAG=${PHP_VERSION:-8.0.12}-cli-alpine
      tags:
        # - latest
        # - cli-alpine
        - ${PHP_VERSION:-8.0.12}-cli-alpine
      repo: maoxuner/php
      username: maoxuner
      password:
        from_secret: docker-password

  - name: php-fpm
    image: plugins/docker
    volumes:
      - name: dockersock
        path: /var/run
    settings:
      # mirror: https://mirror.ccs.tencentyun.com
      # mirror: https://nex18i4o.mirror.aliyuncs.com
      # mtu: 1450
      daemon_off: "true"
      # dry_run: "true"
      context: php-fpm
      dockerfile: php-fpm/Dockerfile
      build_args:
        - PHP_TAG=${PHP_VERSION:-8.0.12}-fpm-alpine
      tags:
        # - fpm-alpine
        - ${PHP_VERSION:-8.0.12}-fpm-alpine
      repo: maoxuner/php
      username: maoxuner
      password:
        from_secret: docker-password

  - name: notify
    image: lddsb/drone-dingtalk-message
    settings:
      success_token:
        from_secret: dingtalk-success-token
      success_secret:
        from_secret: dingtalk-success-secret
      failure_token:
        from_secret: dingtalk-failure-token
      failure_secret:
        from_secret: dingtalk-failure-secret
      lang: zh_CN
      msg_type: markdown
      msg_at_all: false
    commands:
      - set -e
      - |
        # DRONE_BUILD_STATUS always success in Kubernetes
        # https://discourse.drone.io/t/drone-build-status-always-success-in-kubernetes/6627
        if [ -f /run/drone/env ]; then
            grep DRONE_ /run/drone/env > /tmp/env
            source /tmp/env
        fi
      - |
        if [ $DRONE_BUILD_STATUS = "success" ]; then
            export PLUGIN_TOKEN=$PLUGIN_SUCCESS_TOKEN
            export PLUGIN_SECRET=$PLUGIN_SUCCESS_SECRET
        else
            export PLUGIN_TOKEN=$PLUGIN_FAILURE_TOKEN
            export PLUGIN_SECRET=$PLUGIN_FAILURE_SECRET
        fi
      - /bin/drone-dingtalk
    when:
      status:
        - success
        - failure

services:
  - name: docker
    image: docker:20.10.10-dind
    privileged: true
    volumes:
      - name: dockersock
        path: /var/run
    command:
      - "--data-root"
      - "/var/lib/docker"
      - "--host=unix:///var/run/docker.sock"
      - "--registry-mirror"
      - "https://nex18i4o.mirror.aliyuncs.com"
      - "--mtu"
      - "1450"

volumes:
  - name: dockersock
    temp: {}

---
kind: secret
name: docker-password
get:
  path: drone-secret
  name: docker_password

---
kind: secret
name: dingtalk-success-token
get:
  path: drone-secret
  name: dingtalk_success_token

---
kind: secret
name: dingtalk-success-secret
get:
  path: drone-secret
  name: dingtalk_success_secret

---
kind: secret
name: dingtalk-failure-token
get:
  path: drone-secret
  name: dingtalk_failure_token

---
kind: secret
name: dingtalk-failure-secret
get:
  path: drone-secret
  name: dingtalk_failure_secret
