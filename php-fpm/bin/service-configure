#!/bin/sh

function service_configure_help()
{
    cat <<EOF
Service Configuration Manager

Usage:
  service-configure SERVICE COMMAND [FILE]...

Available Services:
  nginx         Nginx
  crontab       Crond
  supervisor    Supervisord

Available Commands:
  load          Load service configurations
  reload        Load service configurations and reload service
  unload        Unload current configurations
  list          List all configurations
EOF
}

function service_configure_reload()
{
    case $1 in
        crontab)
            supervisorctl restart core:crond
        ;;
        nginx)
            nginx -s reload
        ;;
        supervisor)
            supervisorctl reread
            supervisorctl reload
        ;;
        *)
        ;;
    esac
}

svc=$1
cmd=$2
shift 2

set -e

case $svc in
    crontab)
        source_path=${CRONTAB_CONFIG}
        target_path=/etc/crontabs
    ;;
    nginx)
        source_path=${NGINX_CONFIG}
        target_path=/etc/nginx/conf.d
    ;;
    supervisor)
        source_path=${SUPERVISOR_CONFIG}
        target_path=/etc/supervisor.d
    ;;
    "")
        service_configure_help
        exit
    ;;
    *)
        echo "service [$svc] not found"
        exit 1
    ;;
esac

case $cmd in
    load|reload)
        if [[ ! -d $source_path ]]; then
            echo "service [$svc] source path [$source_path] not exists"
            exit 1
        fi

        cd $source_path
        if [[ "$*" ]]; then
            cp -rpf $@ $target_path/
        else
            cp -rpf . $target_path/
        fi
        cd - > /dev/null

        if [[ $cmd = "reload" ]]; then
            service_configure_reload $svc
        fi
    ;;
    unload)
        cd $target_path
        if [[ "$*" ]]; then
            rm -rf $@
        else
            rm -rf *
        fi
        cd - > /dev/null
    ;;
    list)
        if [[ -d $source_path ]]; then
            echo "Source:"
            ls $source_path
        fi
        echo "Current:"
        ls $target_path
    ;;
    *)
        echo "command [$cmd] not found"
        exit 1
    ;;
esac
